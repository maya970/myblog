<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Details</title>
    <style>
        /* Add your CSS here */
    </style>
</head>
<body>
    <div class="container">
        <div id="bookDetails">
            <!-- Book details will be populated here -->
        </div>
        <h3>Reader Comments</h3>
        <div id="comments">
            <!-- Comments will be populated here -->
        </div>
        <form id="addCommentForm">
            <h3>Add a new comment</h3>
            <textarea id="commentText" placeholder="Your comment" required></textarea>
            <button type="submit">Add Comment</button>
        </form>
    </div>

    <script>
        async function loadBookDetails(bookName) {
            let months = ['2024-01', '2024-02']; // Add all month files here
            for (let month of months) {
                let response = await fetch(`/api/books/${month}`);
                let text = await response.text();
                let rows = text.split('\n').filter(row => row.trim() !== '');
                for (let row of rows) {
                    let columns = row.split(',');
                    if (columns.length === 5 && columns[0] === bookName) {
                        document.getElementById('bookDetails').innerHTML = `
                            <h2>${columns[0]}</h2>
                            <p>Author: ${columns[1]}</p>
                            <p>Year: ${columns[2]}</p>
                            <p>Category: ${columns[3]}</p>
                            <p>Rating: ${columns[4]}</p>
                        `;
                        return;
                    }
                }
            }
        }

        async function loadComments(bookName) {
            let response = await fetch(`/api/comments/${bookName}`);
            if (response.ok) {
                let text = await response.text();
                let comments = text.split('\n').filter(comment => comment.trim() !== '');
                let commentsContainer = document.getElementById('comments');
                commentsContainer.innerHTML = '';
                for (let comment of comments) {
                    let commentDiv = document.createElement('div');
                    commentDiv.innerText = comment;
                    commentsContainer.appendChild(commentDiv);
                }
            }
        }

        document.getElementById('addCommentForm').addEventListener('submit', async function (event) {
            event.preventDefault();

            let bookName = new URLSearchParams(window.location.search).get('name');
            let commentText = document.getElementById('commentText').value;

            let response = await fetch(`/api/comments/${bookName}`, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: commentText + '\n',
            });

            if (response.ok) {
                loadComments(bookName);
            }
        });

        let bookName = new URLSearchParams(window.location.search).get('name');
        loadBookDetails(bookName);
        loadComments(bookName);
    </script>
</body>
</html>
